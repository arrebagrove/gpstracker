@{
    ViewBag.Title = "Session";
}

@section scripts
{
    <!-- Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <!-- Initialize google maps -->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
        var map;
        var sessionKey = $(location).attr('pathname').split('/')[2];

        function initialize() {

            var myLatlng = new google.maps.LatLng(47.377677, 8.526544);
            var mapOptions = {
                zoom: 2,
                center: myLatlng
            }
            map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

            $.getJSON("/api/locations/" + sessionKey, function(data) {
                addPoints(data);
            });
        };

        google.maps.event.addDomListener(window, 'load', initialize);


        // Reference the auto-generated proxy for the hub.
        var mapHub = $.connection.mapHub;

        // Define client methods (can be called by server)
        mapHub.client.updatePosition = function(data) {
            addPoints(data);
        };

        // Initialize
        $.connection.hub.start().done(function() {

            if ($('#displayname').val() === '') {
                $('#displayname').val(prompt('Enter your name:', 'User'));
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                        propagatePosition(position);

                        map.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                        map.setZoom(10);
                    },
                    function(error) {
                        alert("Error occurred. Error code: " + error.code);
                        // error.code can be:
                        //   0: unknown error
                        //   1: permission denied
                        //   2: position unavailable (error response from locaton provider)
                        //   3: timed out
                    });

                navigator.geolocation.watchPosition(function(position) {
                    propagatePosition(position);

                    map.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                });
            };

        });

        function propagatePosition(position) {
            var speed = position.coords.speed != null ? position.coords.speed : 0;
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var name = $('#displayname').val();
            if (!(lat === 0.0 && lng === 0.0)) {
                mapHub.server.propagatePosition({ username: name, lat: lat, lng: lng, speed: speed }, sessionKey);
            }
        }

        function addPoints(data) {
            if (data.length > 0) {
                addGoogleMapPoints(data);
            }
        }

        function addInfoWindow(marker, message) {
            var infoWindow = new google.maps.InfoWindow({
                content: message
            });

            google.maps.event.addListener(marker, 'click', function() {
                infoWindow.open(map, marker);
            });
        }

        var markersArray = [];

        google.maps.Map.prototype.clearMarkers = function() {
            for (var i = 0; i < markersArray.length; i++) {
                markersArray[i].setMap(null);
            }
            markersArray.length = [];
        };

        // To add Google Map Points
        function addGoogleMapPoints(loc) {
            map.clearMarkers();
            for (i = 0; i < loc.length; i++) {
                var pnt = loc[i];

                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pnt.Lat, pnt.Lng),
                    map: map,
                    title: 'Click me!',
                    clickable: true
                });
                markersArray.push(marker);

                var contentString = '<div id="content">' +
                    '<div id="siteNotice">' +
                    '</div>' +
                    '<h1 id="firstHeading" class="firstHeading">' + pnt.Username + '</h1>' +
                    '<div id="bodyContent">' +
                    '<p><b>Position</b><br/>' +
                    'Latitude: ' + pnt.Lat + ' - Longitude: ' + pnt.Lng + ' - Speed: ' + pnt.Speed +
                    '</p>' +
                    '</div>' +
                    '</div>';

                addInfoWindow(marker, contentString);
            }
        }

    </script>
}

<input type="hidden" id="displayname" />
<div id="map-canvas"></div>

